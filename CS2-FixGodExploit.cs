using CounterStrikeSharp.API.Core;
using CounterStrikeSharp.API.Core.Attributes;
using CounterStrikeSharp.API.Modules.Commands;

[MinimumApiVersion(168)]
public partial class CS2_FixGodExploit : BasePlugin
{
	private readonly Dictionary<int, DateTime> allowedChangeDateTime = new Dictionary<int, DateTime>();

	public override string ModuleName => "CS2-FixGodExploit";
	public override string ModuleDescription => "Fix for god exploit";
	public override string ModuleAuthor => "daffyy";
	public override string ModuleVersion => "1.0.1";

	public override void Load(bool hotReload)
	{
		AddCommandListener("jointeam", JoinTeamHandler);
	}

	public HookResult OnClientDisconnect(EventPlayerDisconnect @event, GameEventInfo info)
	{
		CCSPlayerController? player = @event.Userid;

		if (player is null || !player.IsValid || player.IsHLTV || player.IsBot)
			return HookResult.Continue;

		if (allowedChangeDateTime.ContainsKey(player.Slot))
			allowedChangeDateTime.Remove(player.Slot);

		return HookResult.Continue;
	}

	public HookResult JoinTeamHandler(CCSPlayerController? player, CommandInfo commandInfo)
	{
		if (player is null || !player.IsValid || player.IsHLTV || player.IsBot || player.Connected != PlayerConnectedState.PlayerConnected)
			return HookResult.Continue;

		if (player.Team == CounterStrikeSharp.API.Modules.Utils.CsTeam.None || player.Team == CounterStrikeSharp.API.Modules.Utils.CsTeam.Spectator)
			return HookResult.Continue;

		if (allowedChangeDateTime.ContainsKey(player.Slot) && allowedChangeDateTime[player.Slot] > DateTime.Now)
			return HookResult.Handled;

		Random random = new Random();
		int randomNumber = random.Next(2, 6);
		allowedChangeDateTime[player.Slot] = DateTime.Now.AddSeconds(randomNumber);

		return HookResult.Continue;
	}
}
